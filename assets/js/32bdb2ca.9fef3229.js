"use strict";(self.webpackChunkstately_docs=self.webpackChunkstately_docs||[]).push([[11726],{3905:(e,t,a)=>{a.r(t),a.d(t,{MDXContext:()=>c,MDXProvider:()=>p,mdx:()=>g,useMDXComponents:()=>d,withMDXComponents:()=>u});var o=a(67294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(){return r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var o in a)Object.prototype.hasOwnProperty.call(a,o)&&(e[o]=a[o])}return e},r.apply(this,arguments)}function s(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,o)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?s(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,o,n=function(e,t){if(null==e)return{};var a,o,n={},r=Object.keys(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var c=o.createContext({}),u=function(e){return function(t){var a=d(t.components);return o.createElement(e,r({},t,{components:a}))}},d=function(e){var t=o.useContext(c),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},p=function(e){var t=d(e.components);return o.createElement(c.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},m=o.forwardRef((function(e,t){var a=e.components,n=e.mdxType,r=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=d(a),p=n,m=u["".concat(s,".").concat(p)]||u[p]||h[p]||r;return a?o.createElement(m,i(i({ref:t},c),{},{components:a})):o.createElement(m,i({ref:t},c))}));function g(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=a.length,s=new Array(r);s[0]=m;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:n,s[1]=i;for(var c=2;c<r;c++)s[c]=a[c];return o.createElement.apply(null,s)}return o.createElement.apply(null,a)}m.displayName="MDXCreateElement"},72831:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>c});var o=a(87462),n=(a(67294),a(3905));const r={title:"State machines: How to stop making Horcruxes in your code",description:"There are several ways of mitigating horcruxes. But visualisations can prevent bugs, so why not go further?",tags:["business logic","xstate","statechart","useReducer"],authors:["matt"],image:"/blog/2020-07-27-state-machines-how-to-stop-making-horcruxes-in-your-code.png",slug:"2020-07-27-state-machines-how-to-stop-making-horcruxes-in-your-code",date:new Date("2020-07-27T00:00:00.000Z")},s=void 0,i={permalink:"/blog/2020-07-27-state-machines-how-to-stop-making-horcruxes-in-your-code",editUrl:"https://github.com/statelyai/docs/edit/main/blog/2020-07-27-state-machines-how-to-stop-making-horcruxes-in-your-code/index.mdx",source:"@site/blog/2020-07-27-state-machines-how-to-stop-making-horcruxes-in-your-code/index.mdx",title:"State machines: How to stop making Horcruxes in your code",description:"There are several ways of mitigating horcruxes. But visualisations can prevent bugs, so why not go further?",date:"2020-07-27T00:00:00.000Z",formattedDate:"July 27, 2020",tags:[{label:"business logic",permalink:"/blog/tags/business-logic"},{label:"xstate",permalink:"/blog/tags/xstate"},{label:"statechart",permalink:"/blog/tags/statechart"},{label:"useReducer",permalink:"/blog/tags/use-reducer"}],readingTime:4.25,hasTruncateMarker:!0,authors:[{name:"Matt Pocock",title:"Stately Team",url:"https://github.com/mattpocock",imageURL:"https://ascelcgzufjyvdzuplwo.supabase.co/storage/v1/object/public/avatars/matt.png",key:"matt"}],frontMatter:{title:"State machines: How to stop making Horcruxes in your code",description:"There are several ways of mitigating horcruxes. But visualisations can prevent bugs, so why not go further?",tags:["business logic","xstate","statechart","useReducer"],authors:["matt"],image:"/blog/2020-07-27-state-machines-how-to-stop-making-horcruxes-in-your-code.png",slug:"2020-07-27-state-machines-how-to-stop-making-horcruxes-in-your-code",date:"2020-07-27T00:00:00.000Z"},prevItem:{title:"\u201cJust use props\u201d: An opinionated guide to React and XState",permalink:"/blog/2021-01-11-just-use-props-an-opinionated-guide-to-react-and-xstate"},nextItem:{title:"How to tell a bad boolean from a good boolean",permalink:"/blog/2020-05-27-state-management-bad-bolean-good-boolean"}},l={authorsImageUrls:[void 0]},c=[{value:"The Soul of your app\u2019s logic",id:"the-soul-of-your-apps-logic",level:2},{value:"Going beyond usual evil",id:"going-beyond-usual-evil",level:2},{value:"Statecharts",id:"statecharts",level:2},{value:"Make a bet on XState",id:"make-a-bet-on-xstate",level:2}],u=(d="Tweet",function(e){return console.warn("Component "+d+" was not imported, exported, or provided by MDXProvider as global scope"),(0,n.mdx)("div",e)});var d;const p={toc:c};function h(e){let{components:t,...a}=e;return(0,n.mdx)("wrapper",(0,o.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,n.mdx)("head",null,(0,n.mdx)("link",{rel:"canonical",href:"https://dev.to/mpocock1/state-machines-how-to-stop-making-horcruxes-in-your-code-gl5"})),(0,n.mdx)("p",null,"My code contains ",(0,n.mdx)("a",{parentName:"p",href:"https://harrypotter.fandom.com/wiki/Horcrux"},"Horcruxes"),". I\u2019m not proud to admit it, since to make a Horcrux you need to commit a murder. The murders seemed intuitive at the time, and were usually for expedience. But nonetheless, I am a murderer."),(0,n.mdx)("p",null,"Let\u2019s talk about how I got here."),(0,n.mdx)("h2",{id:"the-soul-of-your-apps-logic"},"The Soul of your app\u2019s logic"),(0,n.mdx)("p",null,"For an app to remain maintainable, its soul must remain intact. For many apps, logic is usually expressed in changes to state and behaviour."),(0,n.mdx)("p",null,"For instance, some logic for a modal might be expressed like this:"),(0,n.mdx)("pre",null,(0,n.mdx)("code",{parentName:"pre",className:"language-ts"},'const modalReducer = (state = { isOpen: false }, action) => {\n  switch (action.type) {\n    case "CLOSE":\n      return {\n        isOpen: false,\n      };\n    case "OPEN":\n      return {\n        isOpen: true,\n      };\n    default:\n      return state;\n  }\n};\n')),(0,n.mdx)("p",null,"This is the reducer pattern, popularised by libraries like ",(0,n.mdx)("a",{parentName:"p",href:"https://redux.js.org/introduction/getting-started"},"Redux"),". In ",(0,n.mdx)("a",{parentName:"p",href:"https://reactjs.org/"},"React"),", we'd use this reducer in a ",(0,n.mdx)("inlineCode",{parentName:"p"},"useReducer")," hook:"),(0,n.mdx)("pre",null,(0,n.mdx)("code",{parentName:"pre",className:"language-ts"},'const [state, dispatch] = useReducer(modalReducer);\n\n<button onClick={() => dispatch({ type: "OPEN" })}>Open Modal</button>;\n')),(0,n.mdx)("p",null,"If you want to know what happens when you dispatch the ",(0,n.mdx)("inlineCode",{parentName:"p"},"OPEN")," action, you only need look in one place: the ",(0,n.mdx)("inlineCode",{parentName:"p"},"modalReducer"),". This part of your app is easy to keep bug-free, because all the logic for how it works is contained in one place."),(0,n.mdx)("p",null,"But let\u2019s say that requirements change. Now, before you open the modal you\u2019ll need to fetch something from the API to check if you can open it. This seems intuitive enough:"),(0,n.mdx)("pre",null,(0,n.mdx)("code",{parentName:"pre",className:"language-ts"},"    const [state, dispatch] = useReducer(modalReducer);\n\n    <button onClick={async () => {\n      const canOpenTheModal = await checkIfUserCanOpenIt();\n      if (canOpenTheModal) {\n        dispatch({ type: 'OPEN' });\n      }\n    }>\n      Open Modal\n    </button>\n")),(0,n.mdx)("p",null,"The ",(0,n.mdx)("inlineCode",{parentName:"p"},"onClick")," handler is now making the API check to see if it should open the modal. If there\u2019s a bug with the way the modal opens, there are now two places you need to check, the reducer and the event handler."),(0,n.mdx)("p",null,"The soul of your business logic has been split. Just like that, you made a Horcrux."),(0,n.mdx)("h2",{id:"going-beyond-usual-evil"},"Going beyond usual evil"),(0,n.mdx)("p",null,"The first Horcrux is never really the issue. You can survive one or two splits in your business logic. The trouble comes when you reach six or seven, split out over several 800-line files. I have wept over classes with dozens of methods, sequences with dozens of asynchronous steps."),(0,n.mdx)("p",null,"Logic split into more than one place cannot be visualised. If it can\u2019t be visualised, it can\u2019t be modified, deleted or extended safely."),(0,n.mdx)("p",null,"Let me make this plain: ",(0,n.mdx)("strong",{parentName:"p"},"Any code that cannot be concretely visualised will, at some point, result in a bug.")),(0,n.mdx)("p",null,"There are several ways of mitigating horcruxes. You can push to make your code more readable, writing clean event handlers which don\u2019t contain any logic. You can try to colocate as much as your logic as possible, for instance using ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/erikras/ducks-modular-redux"},"ducks")," patterns."),(0,n.mdx)("p",null,"But now we know that visualisation can prevent bugs, why not go further?"),(0,n.mdx)("h2",{id:"statecharts"},"Statecharts"),(0,n.mdx)("p",null,"I recently embarked on the most complex task I\u2019d ever attempted as a developer - building a video chat app with multiple third-party integrations. Most of the business logic would take place on a single page - the chat portal. I needed to handle multiple user types, chat, notifications, input changes... And many more things."),(0,n.mdx)("p",null,"I\u2019d been using ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/davidkpiano/xstate"},"XState"),", and read that it could be used for visualising complex behaviours, such as Ryan Florence\u2019s checkout:"),(0,n.mdx)(u,{id:"1084248892072329216",mdxType:"Tweet"}),(0,n.mdx)("p",null,"It produces clickable visualisations which you can share and walk through. For instance, the modal reducer above could be expressed in ",(0,n.mdx)("a",{parentName:"p",href:"https://xstate.js.org/viz/?gist=56c56d2be397c4d5bea934c6d89e788d"},"this statechart"),"."),(0,n.mdx)("p",null,(0,n.mdx)("img",{parentName:"p",src:"https://res.cloudinary.com/practicaldev/image/fetch/s--XmLhsdr5--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/i/2lb0ctiu7s207t9w44mg.png",alt:"A statechart describing a modal which opens and closes"})),(0,n.mdx)("p",null,"I knew that if I wasn\u2019t careful, I\u2019d end up with 25-30 horcruxes under my belt, logic carried in dozens of event handlers. So I wrote the machine in XState. I even wrote a VSCode extension so I could have the visualiser inline as I went along. Here\u2019s what I ended up with:"),(0,n.mdx)("p",null,(0,n.mdx)("img",{parentName:"p",src:"https://res.cloudinary.com/practicaldev/image/fetch/s--oY3xYHhl--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/i/33vxe2bcsxn8uvfzlgva.png",alt:"An XState diagram of my video chat app"})),(0,n.mdx)("p",null,"Every part of this crazy complex app can now be visualised. I can see which conditions lead to which states. I can which actions are called on which events."),(0,n.mdx)("p",null,"At an early stage of the process, I was even able to ask the client about complex interactions in the logic, just by walking them through the statechart. Weeks later, when it needed extending, I was able to insert a new piece of state without breaking anything else."),(0,n.mdx)("p",null,"Any time someone needs to see how the viewing page works, they can fire up the visualiser. Their usual first reaction is one of terror. State machines don't create complexity, they reveal it. But by clicking through the machine, they can concretely see how the app works, and feel comfortable making changes."),(0,n.mdx)("h2",{id:"make-a-bet-on-xstate"},"Make a bet on XState"),(0,n.mdx)("hr",null),(0,n.mdx)("p",null,"If you\u2019re having trouble deciphering the logic of a legacy app, try visualising it in XState. Try working through a problem with a fellow dev. At ",(0,n.mdx)("a",{parentName:"p",href:"http://yozobi.com/"},"Yozobi"),", we\u2019re making a bet that state machines are going to change web development. If you want to learn more about them, follow me and we can try to heal our Horcruxes together."))}h.isMDXComponent=!0}}]);